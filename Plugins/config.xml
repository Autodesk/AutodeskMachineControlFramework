<?xml version="1.0" encoding="UTF-8"?>
<machinedefinition xmlns="http://schemas.autodesk.com/amc/machinedefinitions/2020/02">

  <services threadcount="32" />


  <driver name="marlin" library="driver_marlin" type="marlin-2.0" />
  <driver name="mqtt" library="driver_mqtt" type="mqtt" configurationresource="mqtt_config" />
  
    <statemachine name="main" description="Main System" initstate="init" failedstate="fatalerror" library="plugin_main">
  	 	  		  
  	  <parametergroup name="jobinfo" description="Job Information">
  		<parameter name="jobname" description="Job Name" default="Job Name" type="string" />
  		<parameter name="jobuuid" description="Job UUID" default="00000000-0000-0000-0000-000000000000" type="string" />
  		<parameter name="layercount" description="Layer Count" default="0" type="int" />
  		<parameter name="currentlayer" description="Current Layer" default="0" type="int" />
  		<parameter name="autostart" description="Automatically start job after init" default="0" type="bool" />
  		<parameter name="printinprogress" description="Print is in progress" default="0" type="bool" />
  	  </parametergroup>

  	  <parametergroup name="temperaturecontrol" description="Temperature Control">
  		<parameter name="fanid" description="Fan ID to set target speed" default="0" type="int" />
  		<parameter name="fanspeed" description="Fan Speed" default="128" type="double" />
  		<parameter name="extruderid" description="Extruder ID to set/get target temperature" default="0" type="int" />
  		<parameter name="targetextrudertemperature" description="Target Extruder Temperature" default="25.0" type="double" />
  		<parameter name="targetbedtemperature" description="Target Bed Temperature" default="25.0" type="double" />
  	  </parametergroup>

  	  <parametergroup name="timeoutdata" description="Timeouts for different processes">		
  		<parameter name="layergracetime" description="Grace time [ms] added to calculated layer timeout" default="1000" type="int" />
		<parameter name="printerconnectandinitialise" type="int" default="20000" description="Timeout [ms] for connecting and initialising printer" />
  	  </parametergroup>

  	  <signaldefinition name="signal_startjob">
  		<parameter name="jobuuid" type="string" />
  		<result name="success" type="bool" />		
  	  </signaldefinition>	 	  	  	     
    
  	  <signaldefinition name="signal_resetfatalerror">
  		<result name="success" type="bool" />		
  	  </signaldefinition>	 	  	  	     
    
  	  <signaldefinition name="signal_cleartemperatureandfan">
  		<result name="success" type="bool" />
  	  </signaldefinition>	 

  	  <signaldefinition name="signal_gettemperature">
  		<parameter name="extrudertemperature" type="double" />
  		<parameter name="bedtemperature" type="double" />
  		<result name="success" type="bool" />
  	  </signaldefinition>	 

  	  <state name="init" repeatdelay="100">
  			<outstate target="idle" />
  	  </state>
  
  
  	  <state name="idle" repeatdelay="50">
  			<outstate target="idle" />
  			<outstate target="startprocess" />
  	  </state>
  
  	  <state name="startprocess" repeatdelay="100">	  
  			<outstate target="extrudelayer" />
  	  </state>
  	  
  
  	  <state name="extrudelayer" repeatdelay="10">
  			<outstate target="nextlayer" />
  	  </state>
  	  
  
  	  <state name="nextlayer" repeatdelay="10">
  			<outstate target="extrudelayer" />
  			<outstate target="finishprocess" />
  	  </state>
  
  
  	  <state name="finishprocess" repeatdelay="100">	  
  			<outstate target="idle" />
  	  </state>
  		
  	  <state name="fatalerror" repeatdelay="5000">	  
  			<outstate target="init" />
  			<outstate target="fatalerror" />
  	  </state>
    
  	  
    </statemachine>
  
  
  
    <statemachine name="printerconnection" description="Printer Connection System" initstate="init" failedstate="fatalerror" library="plugin_printerconnection">
  	  
  	  <signaldefinition name="signal_doextrudelayer">
  		<parameter name="jobuuid" type="string" />
   		<parameter name="layerindex" type="int" />
   		<parameter name="layertimeout" type="double" />
  		<result name="success" type="bool" />
  	  </signaldefinition>	 

  	  <signaldefinition name="signal_dohoming">
  		<result name="success" type="bool" />
  	  </signaldefinition>	 

  	  <signaldefinition name="signal_doextruderinit">
  		<result name="success" type="bool" />
  	  </signaldefinition>	 

	  <signaldefinition name="signal_setpidvalues">
		<parameter name="dp" type="double" />
		<parameter name="di" type="double" />
		<parameter name="dd" type="double" />
		<result name="success" type="bool" />	
	  </signaldefinition>	  

	  <signaldefinition name="signal_disconnect">
		<result name="success" type="bool" />	
	  </signaldefinition>	  

	  <signaldefinition name="signal_connect">
		<result name="success" type="bool" />	
	  </signaldefinition>	  

	  <signaldefinition name="signal_emergencystop">
		<result name="success" type="bool" />	
	  </signaldefinition>	  

  	  <signaldefinition name="signal_settemperature">
  		<parameter name="extrudersetvalue" type="bool" />
  		<parameter name="extruderid" type="int" />
  		<parameter name="extrudertemperature" type="double" />
  		<parameter name="extruderdowait" type="bool" />
  		<parameter name="bedsetvalue" type="bool" />
  		<parameter name="bedtemperature" type="double" />
  		<parameter name="beddowait" type="bool" />
  		<result name="success" type="bool" />
  	  </signaldefinition>	 

  	  <signaldefinition name="signal_setfanspeed">
  		<parameter name="fanid" type="int" />
  		<parameter name="fanspeed" type="double" />
  		<result name="success" type="bool" />
  	  </signaldefinition>	 

  	  <signaldefinition name="signal_dofinalizeextrude">
  		<result name="success" type="bool" />
  	  </signaldefinition>	 

  	  <signaldefinition name="signal_resetfatalerror">
  		<result name="success" type="bool" />		
  	  </signaldefinition>	 	  	  	     
    
	  <parametergroup name="extrudedata" description="Extruder settings">
  		<parameter name="initialextrude" description="Value for initial extrusion" default="3" type="double" />
  		<parameter name="retractextrude" description="Value for retract/restore extrusion after/before each layer" default="1" type="double" />
	  </parametergroup>

  	  <parametergroup name="comdata" description="COM Configuration">		
  		<parameter name="port" description="COM Port" default="COM4" type="string" />
  		<parameter name="baudrate" description="Baud rate" default="115200" type="int" />
		<parameter name="connectinitialresponsetimeout" type="int" default="2000" description="Timeout [ms] for initial response of printer while connecting" />
  	  </parametergroup>

  	  <driverparametergroup name="printerstate" description="Printer State Data" driver="marlin" /> 
	  
  	  <state name="init" repeatdelay="100">
  			<outstate target="idle" />
  	  </state>
  
  
  	  <state name="idle" repeatdelay="10">	  	 
  			<outstate target="idle" />
  			<outstate target="doextrudelayer" />
  	  </state>
  
  	  <state name="doextrudelayer" repeatdelay="10">
  			<outstate target="idle" />
  	  </state>
  
  	  <state name="fatalerror" repeatdelay="5000">	  
  			<outstate target="init" />
  			<outstate target="fatalerror" />
  	  </state>
    
  	  
    </statemachine>



  <statemachine name="pidcontrol_extruder" description="Temperature PID Control System for Extruder" initstate="init" failedstate="fatalerror" library="plugin_pidcontrol">

	  <parametergroup name="status" description="Status of PID Control">
		<parameter name="isactive" description="PID Control is active" default="0" type="bool" />
		<parameter name="dp" description="dP Value" default="0" type="double" />
		<parameter name="di" description="dI Value" default="0" type="double" />
		<parameter name="dd" description="dD Value" default="0" type="double" />
	  </parametergroup>

	  
	  <signaldefinition name="signal_startcontrolling">
		<result name="success" type="bool" />		
	  </signaldefinition>
	  
	  
	  <signaldefinition name="signal_stopcontrolling">
		<result name="success" type="bool" />		
	  </signaldefinition>	  	     	    
	  
				
	  <state name="init" repeatdelay="100">
			<outstate target="idle" />
	  </state>


	  <state name="idle" repeatdelay="50">	  	 
			<outstate target="idle" />
			<outstate target="controlling" />
	  </state>

	  <state name="controlling" repeatdelay="50">	  	 
			<outstate target="idle" />
			<outstate target="controlling" />
	  </state>	  

	  <state name="fatalerror" repeatdelay="5000">	  
			<outstate target="init" />
			<outstate target="idle" />
			<outstate target="fatalerror" />
	  </state>
  
	  
  </statemachine>

  
    <userinterface appname="Autodesk Machine Control Framework" copyright="2020 Autodesk Inc." mainpage="main" library="plugin_userinterface">
  
		<logo resource="ui_logo" aspectratio="2.5" />
		
		<page name="main">
			<content name="infobox" title="SLM Demo System" headline="">
				<image resource="ui_machine" aspectratio="2.5" maxheight="400"/>
				<paragraph text="This sample configuration serves as Laser Powderbed Fusion demo implementation."/>
				<upload class="build" caption="Select 3MF files to upload" successevent="onuploadfinished"/>

				<form name="simulationparameters">
					<switch name="simulatelaser" caption="Simulate Laser Control" sync:value="main.configuration.simulatelaser" changeevent="changesimulationparameter"/>
					<switch name="simulateplc" caption="Simulate PLC behaviour" sync:value="main.configuration.simulateplc" changeevent="changesimulationparameter"/>
				</form>

				<buttongroup>
					<button caption="Test Movement" event="testmovement"/>
				</buttongroup>

			</content>

		</page>


		<page name="buildlist">
			<content name="buildlibrary" title="Build Library">
				<upload class="build" caption="Select 3MF files to upload" successevent="onuploadfinished"/>
				<buildlist loadingtext="Loading builds" entriesperpage="20" selectevent="onselectbuild"/>
			</content>
		</page>

		<page name="previewbuild">

			<grid name="previewgrid">
				<column width="180" unit="pt"/>
				<column width="3" unit="free"/>
				<column width="3" unit="free"/>
				<column width="3" unit="free"/>
				<column width="3" unit="free"/>

				<row height="50" unit="pt"/>
				<row height="50" unit="pt"/>
				<row height="1" unit="free"/>


				<content name="buildimage" columnstart="1" rowstart="1" columnend="1" rowend="2">
					<image resource="tray" x="50" y="50" width="120" height="100" z-layer="2" visible="1" aspectratio="1.8"/>
				</content>

				<content name="buildinformation1" columnstart="2" rowstart="1" columnend="2" rowend="1" rowposition="centered">
					<form name="infoform1">
						<edit name="buildname"
						caption="Build name"
						value="Build 274642"
						readonly="1" />
					</form>
				</content>


				<content name="buildinformation2" columnstart="2" rowstart="2" columnend="2" rowend="2" rowposition="centered">
					<form name="infoform2">
						<edit name="layers"
						caption="Build details"
						value="1 part."
						readonly="1" />
					</form>

				</content>

				<content name="layerinformation1" columnstart="3" rowstart="1" columnend="3" rowend="1" rowposition="centered">
					<form name="layerform1">
						<edit name="currentlayer"
						caption="Current Layer"
						value="1 / 48"
						readonly="1" />
					</form>
				</content>
				<content name="layerinformation2" columnstart="3" rowstart="2" columnend="3" rowend="2" rowposition="centered">
					<form name="layerform2">
						<edit name="currentheight"
						caption="Current height"
						value="0.1mm / 10.0mm"
						readonly="1" />
					</form>

				</content>

				<content name="settings1" columnstart="4" rowstart="1" columnend="4" rowend="1" rowposition="centered">
					<form name="settingsform1">
						<switch name="showcolors" caption="Hatch Colors"/>
					</form>

				</content>
				<content name="settings2" columnstart="4" rowstart="2" columnend="4" rowend="2" rowposition="centered">
					<form name="settingsform2">
						<switch name="showmodel" caption="Model Geometry"/>
					</form>

				</content>

				<content name="actions1" columnstart="5" rowstart="1" columnend="5" rowend="1" rowposition="centered">
					<buttongroup distribution="equal">
						<button caption="Prepare Build" targetpage="preparebuild" event="startbuildpreparation"/>
					</buttongroup>
				</content>

				<content name="actions2" columnstart="5" rowstart="2" columnend="5" rowend="2" rowposition="centered">
					<buttongroup distribution="equal">
						<button caption="Close Preview" targetpage="buildlist" event="unloadbuildpreview"/>
					</buttongroup>
				</content>


				<layerview name="preview" columnstart="1" rowstart="3" columnend="5" rowend="3">
					<platform sizex="300" sizey="300" originx="150" originy="150" baseimage="buildplate"/>

				</layerview>

			</grid>
		</page>

		<page name="preparebuild">

			<grid name="maingrid">
				<column width="3" unit="free"/>
				<column width="150" unit="pt"/>

				<row height="3" unit="free"/>
				<row height="80" unit="pt"/>

				<content name="manualcontrol1" columnstart="2" rowstart="1" columnend="2" rowend="1" columnposition="left" rowposition="top">

					<form name="processparameters">
						<edit name="o2_value"
						caption="Target Oxygen Value"
						sync:value="main.processsettings.targeto2"
						suffix="ppm"
						readonly="1"
						sync:disabled="main.ui.preparebuilddisabled" />

						<edit name="recoaterspeed" caption="Recoater Speed" sync:value="main.processsettings.recoaterspeed" suffix="mm/s" readonly="1" sync:disabled="main.ui.preparebuilddisabled"/>
						<edit name="gasflowspeed" caption="Gas flow speed" sync:value="main.processsettings.gasflowspeed" suffix="m/s" readonly="1" sync:disabled="main.ui.preparebuilddisabled"/>
					</form>
					<buttongroup>
						<button caption="Change values" event="changemanualvalues"/>
					</buttongroup>

				</content>

				<content name="manualcontrol2" title="" columnstart="2" rowstart="2" columnend="2" rowend="2" columnposition="left" rowposition="centered">
				</content>

				<graphic name="manualcontrol3" title="" columnstart="1" rowstart="1" columnend="1" rowend="1">
				
					<view minx="0" miny="0" maxx="160" maxy="110" showgrid="0" />
										
					<svgimage resource="machinesketch" x="0" y="0" z="45" scalex="1.0" scaley="1.0" angle="0.0" />
					<svgimage name="platform" resource="platform" x="35" y="5" z="50" scalex="1.0" scaley="1.0" angle="0.0" />
					<svgimage name="powderreservoir" resource="platform" x="0" y="0" z="50" scalex="1.0" scaley="1.0" angle="0.0" />
					<svgimage name="recoater" resource="recoatersketch" x="0" y="0" z="50" scalex="1.0" scaley="1.0" angle="0.0" />
					
				</graphic>

				<content name="manualcontrol4" title="" columnstart="1" rowstart="2" columnend="1" rowend="2" columnposition="left" rowposition="centered">

					<buttongroup distribution="equal">
						<button caption="Start Job" event="startbuild"/>
						<button caption="Cancel Preparation" targetpage="main" event="cancelbuildpreparation"/>
					</buttongroup>

				</content>
			</grid>

		</page>


		<page name="buildstatus">

			<grid name="previewgrid">
				<column width="180" unit="pt"/>
				<column width="3" unit="free"/>
				<column width="3" unit="free"/>
				<column width="3" unit="free"/>
				<column width="3" unit="free"/>

				<row height="50" unit="pt"/>
				<row height="50" unit="pt"/>
				<row height="1" unit="free"/>


				<content name="buildimage" columnstart="1" rowstart="1" columnend="1" rowend="2">
					<image resource="tray" x="50" y="50" width="120" height="100" z-layer="2" visible="1" aspectratio="1.8"/>
				</content>

				<content name="buildinformation1" columnstart="2" rowstart="1" columnend="2" rowend="1" rowposition="centered">
					<form name="infoform1">
						<edit name="buildname"
						caption="Build name"
						value="Build 274642"
						readonly="1" />
					</form>
				</content>


				<content name="buildinformation2" columnstart="2" rowstart="2" columnend="2" rowend="2" rowposition="centered">
					<form name="infoform2">
						<edit name="layers"
						caption="Build details"
						value="1 part."
						readonly="1" />
					</form>

				</content>

				<content name="layerinformation1" columnstart="3" rowstart="1" columnend="3" rowend="1" rowposition="centered">
					<form name="layerform1">
						<edit name="currentlayer"
						caption="Current Layer"
						value="1 / 48"
						readonly="1" />
					</form>
				</content>
				<content name="layerinformation2" columnstart="3" rowstart="2" columnend="3" rowend="2" rowposition="centered">
					<form name="layerform2">
						<edit name="currentheight"
						caption="Current height"
						value="0.1mm / 10.0mm"
						readonly="1" />
					</form>

				</content>

				<content name="settings1" columnstart="4" rowstart="1" columnend="4" rowend="1" rowposition="centered">
					<form name="settingsform1">
						<switch name="showcolors" caption="Hatch Colors"/>
					</form>

				</content>
				<content name="settings2" columnstart="4" rowstart="2" columnend="4" rowend="2" rowposition="centered">
					<form name="settingsform2">
						<switch name="showmodel" caption="Model Geometry"/>
					</form>

				</content>

				<content name="actions1" columnstart="5" rowstart="1" columnend="5" rowend="1" rowposition="centered">
					<buttongroup distribution="equal">
						<button caption="Pause Build" event="pausebuild"/>
					</buttongroup>
				</content>

				<content name="actions2" columnstart="5" rowstart="2" columnend="5" rowend="2" rowposition="centered">
					<buttongroup distribution="equal">
						<button caption="Cancel Build" event="cancelbuild"/>
					</buttongroup>
				</content>


				<layerview name="preview" columnstart="1" rowstart="3" columnend="3" rowend="3">
					<platform sizex="300" sizey="300" originx="150" originy="150" sync:layerindex="main.jobinfo.currentlayer"  baseimage="buildplate"/>
				</layerview>
				
				
				<tabs name="buildtabs"  columnstart="4" rowstart="3" columnend="5" rowend="3" >
							
					<content name="systemstate" caption="System State">
					
						<parameterlist loadingtext="Loading parameters">
							<entry statemachine="main" group="jobinfo" />
							<entry statemachine="plc" group="plcstate" />
							<entry statemachine="laser" group="cardconfig" />
							<entry statemachine="laser" group="sdkstate" />
							<entry statemachine="laser" group="correction" />
												
						</parameterlist>	
						
					</content>		

					<content name="part list" caption="Part List">
					
					</content>	

					<content name="systemstate" caption="Log Messages">
					
					</content>					
				
				</tabs>
				

			</grid>
		</page>

		<page name="systemstatus">
			<content name="currentbuild" title="Current System Status" >
			
				<paragraph text="Our colors unite and enrich the Autodesk experience and solidify our brand." />
				<image resource="ui_machine" aspectratio="2.5" maxheight="400" />
				<paragraph text="This is the current machine state." />						
				
				<parameterlist loadingtext="Loading parameters">
					<entry statemachine="main" group="jobinfo" />
					<entry statemachine="printerconnection" group="printerstate" />
				</parameterlist>	
			</content>					
			
		</page>

		<page name="manualcontrol">
			<content name="manualcontrols" title="Printer Control" >
				<paragraph text="Here you find some buttons to control the printer manually." />
				<buttongroup>
					<button caption="Connect" event="connect" targetpage="systemstatus"/>
					<button caption="Home" event="home" targetpage="systemstatus"/>
					<button caption="Clear Temperature & Fan" event="cleartemperatureandfan" targetpage="systemstatus"/>
					<button caption="Error Reset" event="resetfatalerror" targetpage="systemstatus"/>
					<button caption="Emergency Stop" event="emergencystop" targetpage="systemstatus"/>
					<button caption="Disconnect" event="disconnect" targetpage="systemstatus"/>
				</buttongroup>
			</content>					
		</page>

		<page name="systemstatus">

			<content name="currentbuild" title="Current System Status">
				<parameterlist loadingtext="Loading parameters">
					<entry statemachine="main" group="processsettings"/>
					<entry statemachine="main" group="jobinfo"/>
					<entry statemachine="main" group="ui"/>
					<entry statemachine="plc" group="plcconfig"/>
					<entry statemachine="plc" group="plcstate"/>

					<entry statemachine="laser" group="sdkstate"/>

				</parameterlist>
			</content>

		</page>

		<menu>
			<item id="home" icon="mdi-apps" caption="Home" targetpage="main"/>
			<item id="buildlist" icon="mdi-apps" caption="Build Library" targetpage="buildlist"/>
			<item id="preparebuild" icon="mdi-apps" caption="Prepare Build" targetpage="preparebuild"/>
			<item id="buildstatus" icon="mdi-apps" caption="Build Status" targetpage="buildstatus"/>
			<item id="buildreport" icon="mdi-apps" caption="Build Report" targetpage="buildreport"/>
			<item id="systemstatus" icon="mdi-apps" caption="System Status" targetpage="systemstatus"/>
		</menu>


		<toolbar>
			<item id="home" icon="mdi-apps" caption="Home" targetpage="main"/>
		</toolbar>


	</userinterface>
</machinedefinition>








